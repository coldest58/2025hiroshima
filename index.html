<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- é—œéµï¼šä½¿ç”¨ interactive-widget=resizes-content è®“éµç›¤å½ˆå‡ºæ™‚ä½ˆå±€è‡ªå‹•èª¿æ•´ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    
    <!-- iOS Web App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- æ”¹ç‚ºåŠé€æ˜è®“èƒŒæ™¯è‰²å»¶ä¼¸ -->
    <meta name="apple-mobile-web-app-title" content="Japan 2025">
    
    <!-- Android Web App Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FFFDF5">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5pel5pys5bGx6Zm95LmL5peFIDIwMjUiLCJzaG9ydF9uYW1lIjoiSmFwYW4gMjAyNSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjRkZGREY1IiwidGhlbWVfY29sb3IiOiIjRkZGREY1In0=">
    
    <title>æ—¥æœ¬å±±é™½ä¹‹æ—… 2025</title>
    
    <script>
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('ResizeObserver')) return;
            console.error("Global Error:", e);
        }, true);
    </script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kinari': '#FFFDF5',
                        'sumi': '#2B2B2B',
                        'matcha': '#86A697',
                        'sakura': '#F4D5D3',
                        'yamabuki': '#F8B500',
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', '"Noto Sans JP"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* å¼·åˆ¶å…¨è¢å¹•ä½ˆå±€ï¼Œç¦æ­¢ body æ²å‹• */
        html, body {
            height: 100%;
            height: 100dvh; /* ä½¿ç”¨å‹•æ…‹è¦–å£é«˜åº¦ï¼Œå®Œç¾é©æ‡‰ Safari */
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: #FFFDF5;
            color: #2B2B2B;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        
        /* iOS Safe Area æ”¯æ´ */
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        [v-cloak] { display: none !important; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-online { background-color: #10B981; }
        .status-offline { background-color: #EF4444; }
        .status-connecting { background-color: #F59E0B; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .scroll-smooth { scroll-behavior: smooth; }
    </style>
</head>
<body>

    <div id="app" v-cloak class="flex flex-col h-full w-full">
        
        <!-- 1. æ¨™é¡Œåˆ— (Header) - è‡ªç„¶å †ç–Šï¼Œä¸ä½¿ç”¨ fixed -->
        <!-- flex-none ç¢ºä¿é«˜åº¦æ ¹æ“šå…§å®¹è‡ªå‹•æ’é–‹ï¼Œä¸æœƒè¢«å£“ç¸® -->
        <!-- pt-safe-top ç¢ºä¿ä¸æœƒè¢«ç€æµ·æ“‹ä½ -->
        <header class="flex-none z-50 bg-kinari shadow-sm border-b border-stone-100 pt-safe-top">
            <div class="pt-2 pb-2 px-6">
                <div class="flex justify-between items-center mb-1">
                    <h1 class="text-2xl font-black tracking-widest text-stone-700">å±±é™½ãƒ»é—œè¥¿ä¹‹æ—…</h1>
                    <div class="flex items-center gap-2">
                        <div class="text-[10px] bg-white px-2 py-1 rounded-full border border-stone-100 flex items-center h-8">
                            <span class="status-dot" :class="connectionStatusClass"></span>
                            {{ connectionStatusText }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¥æœŸé¸å–® (åªåœ¨è¡Œç¨‹é é¡¯ç¤º) -->
            <div v-if="activeTab === 'itinerary'" class="w-full pb-2">
                <div class="flex overflow-x-auto no-scrollbar px-4 gap-3 py-2" ref="dateScroller">
                    <button v-for="(day, index) in tripDays" :key="index" :id="'date-btn-' + day.date" @click="jumpToDate(day.date)"
                        class="flex flex-col items-center justify-center min-w-[64px] h-[72px] rounded-2xl transition-all duration-300 snap-center shrink-0 border"
                        :class="selectedDate === day.date ? 'bg-stone-800 text-white border-stone-800 scale-105 shadow-md' : 'bg-white text-stone-400 border-stone-100'">
                        <span class="text-xs font-medium">{{ day.dayOfWeek }}</span>
                        <span class="text-xl font-bold">{{ day.dayNum }}</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 2. ä¸»è¦å…§å®¹å€ (Main) - è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ -->
        <!-- flex-1 è®“å®ƒä½”æ“š Header å’Œ Nav ä¹‹é–“çš„æ‰€æœ‰ç©ºé–“ -->
        <!-- overflow-hidden ç¢ºä¿æ²å‹•ç™¼ç”Ÿåœ¨å…§éƒ¨å­å±¤ï¼Œè€Œä¸æ˜¯æ•´é  -->
        <main class="flex-1 relative overflow-hidden bg-stone-50/50 w-full">
            
            <!-- è¡Œç¨‹é  (å·¦å³æ»‘å‹•å®¹å™¨) -->
            <div v-if="activeTab === 'itinerary'" 
                 class="w-full h-full flex overflow-x-auto snap-x snap-mandatory no-scrollbar scroll-smooth" 
                 ref="daysContainer"
                 @scroll="handleDayScroll">
                
                <div v-for="day in tripDays" :key="day.date" :id="'view-' + day.date" 
                     class="min-w-full w-full h-full snap-center overflow-y-auto p-4 pb-24">
                     <!-- pb-24 æ˜¯ç‚ºäº†é¿å…å…§å®¹è¢« FAB æ“‹ä½ï¼Œä¸æ˜¯å› ç‚ºå°è¦½åˆ— -->
                    
                    <div class="space-y-4 pt-2">
                        <!-- Empty State -->
                        <div v-if="getEventsForDay(day.date).length === 0" class="text-center py-20 text-stone-400 text-sm flex flex-col items-center">
                            <i class="fa-solid fa-calendar-plus text-4xl mb-3 opacity-30"></i>
                            <p class="opacity-70">{{ day.date }}<br>å°šç„¡è¡Œç¨‹</p>
                        </div>

                        <!-- Event Cards -->
                        <div v-for="(item, idx) in getEventsForDay(day.date)" :key="item.id" class="relative pl-4 group">
                            <!-- Timeline Line -->
                            <div class="absolute left-0 top-2 bottom-0 w-0.5 bg-stone-200 group-last:bottom-auto group-last:h-full"></div>
                            <div class="absolute left-[-4px] top-2 w-2.5 h-2.5 rounded-full bg-stone-300 border-2 border-white ring-1 ring-stone-200"></div>
                            
                            <div class="bg-white p-4 rounded-2xl card-shadow ml-2 border border-stone-50 relative overflow-hidden">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-col">
                                        <span class="text-2xl font-light text-stone-800">{{ item.time }}</span>
                                        <span class="text-xs text-stone-400 tracking-wide uppercase">{{ item.type || 'Activity' }}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="openEditModal(item)" class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center hover:bg-stone-200"><i class="fa-solid fa-pen text-xs"></i></button>
                                        <button @click="openGoogleMap(item.place)" class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center hover:bg-stone-200"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                                        <button @click="deleteEvent(item.id)" class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100"><i class="fa-solid fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                <h3 class="text-lg font-bold text-stone-700 mb-1">{{ item.place }}</h3>
                                <p v-if="item.note" class="text-sm text-stone-500 bg-stone-50 p-2 rounded-lg mt-2"><i class="fa-regular fa-note-sticky mr-1"></i> {{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- FAB (æ–°å¢è¡Œç¨‹æŒ‰éˆ•) -->
            <!-- absolute position relative to Main, not Body -->
            <button v-if="activeTab === 'itinerary'" @click="openAddModal" class="absolute bottom-6 right-6 w-14 h-14 bg-stone-800 text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:scale-105 transition-transform border-2 border-white/20">
                <i class="fa-solid fa-plus text-xl"></i>
            </button>

            <!-- å…¶ä»–åˆ†é  (é€šç”¨æ²å‹•å®¹å™¨) -->
            <!-- pb-20 ç¢ºä¿åº•éƒ¨å…§å®¹ä¸è²¼é‚Š -->
            <div v-if="activeTab !== 'itinerary'" class="h-full w-full overflow-y-auto p-4 pb-20 bg-white">
                
                <!-- Wallet Content -->
                <div v-if="activeTab === 'wallet'">
                    <div class="bg-stone-800 text-white p-5 rounded-3xl shadow-lg relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-sm font-bold tracking-widest text-stone-300">çµç®—æ¦‚æ³ (ç´„ NT$)</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <label class="text-[10px] text-stone-400">åŒ¯ç‡</label>
                                    <input v-model="exchangeRate" type="number" step="0.001" class="w-16 bg-stone-700 text-white text-xs px-2 py-1 rounded border border-stone-600 focus:border-yamabuki outline-none">
                                </div>
                            </div>
                            <button @click="showMemberModal = true" class="text-xs bg-stone-700 px-3 py-1 rounded-full hover:bg-stone-600 border border-stone-600 flex items-center gap-1 transition-colors">
                                <i class="fa-solid fa-user-gear"></i> æˆå“¡ ({{ membersList.length }})
                            </button>
                        </div>
                        <div class="space-y-2 relative z-10">
                            <div v-for="member in settlementData" :key="member.name" class="flex justify-between items-center border-b border-stone-700 pb-2 last:border-0 last:pb-0">
                                <div><div class="font-bold text-lg">{{ member.name }}</div><div class="text-[10px] text-stone-400">å·²ä»˜ç´„ NT${{ member.paid.toLocaleString() }}</div></div>
                                <div class="text-right"><div class="text-lg font-bold" :class="member.balance >= 0 ? 'text-green-400' : 'text-red-400'">{{ member.balance >= 0 ? '+' : '' }}{{ member.balance.toLocaleString() }}</div><div class="text-[10px] text-stone-400">{{ member.balance >= 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜' }}</div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Expense Form -->
                    <div class="mt-6 bg-white p-5 rounded-2xl border border-stone-200 shadow-sm transition-all duration-300" :class="{'ring-2 ring-stone-800': editingExpenseId}">
                        <h4 class="text-sm font-bold mb-3 text-stone-600 flex justify-between items-center">
                            <span><i class="fa-solid fa-receipt mr-1"></i> {{ editingExpenseId ? 'ç·¨è¼¯æ¶ˆè²»' : 'æ–°å¢æ¶ˆè²»' }}</span>
                            <button v-if="editingExpenseId" @click="cancelEditExpense" class="text-xs text-red-400 underline">å–æ¶ˆç·¨è¼¯</button>
                        </h4>
                        <div class="grid grid-cols-5 gap-3 mb-3">
                            <div class="col-span-2"><select v-model="newExpense.currency" class="w-full bg-stone-50 p-3 rounded-lg text-sm outline-none border border-stone-100 focus:border-stone-300 font-bold"><option value="JPY">JPY Â¥</option><option value="TWD">TWD $</option></select></div>
                            <div class="col-span-3"><input v-model="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-full bg-stone-50 p-3 rounded-lg text-sm outline-none border border-stone-100 focus:border-stone-300"></div>
                        </div>
                        <div class="mb-3"><input v-model="newExpense.item" placeholder="å“é … (å¦‚: æ™šé¤ã€è»Šç¥¨)" class="w-full bg-stone-50 p-3 rounded-lg text-sm outline-none border border-stone-100 focus:border-stone-300"></div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-[10px] text-stone-400 ml-1">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label><select v-model="newExpense.payer" class="w-full bg-stone-50 p-3 rounded-lg text-sm outline-none border border-stone-100"><option v-for="m in membersList" :value="m.name">{{ m.name }}</option></select></div>
                            <div><label class="text-[10px] text-stone-400 ml-1">åˆ†é¡</label><select v-model="newExpense.category" class="w-full bg-stone-50 p-3 rounded-lg text-sm outline-none border border-stone-100"><option value="food">é£²é£Ÿ</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="stay">ä½å®¿</option><option value="ticket">é–€ç¥¨</option></select></div>
                        </div>
                        <div class="mb-4">
                            <label class="text-[10px] text-stone-400 ml-1 mb-1 block">åˆ†å¸³æ–¹å¼</label>
                            <div class="flex bg-stone-50 p-1 rounded-lg border border-stone-100">
                                <button @click="newExpense.splitType = 'average'" :class="newExpense.splitType === 'average' ? 'bg-white shadow text-stone-800' : 'text-stone-400'" class="flex-1 py-2 rounded-md text-xs font-bold transition-all">å¹³å‡åˆ†æ“”</button>
                                <button @click="newExpense.splitType = 'individual'" :class="newExpense.splitType === 'individual' ? 'bg-white shadow text-stone-800' : 'text-stone-400'" class="flex-1 py-2 rounded-md text-xs font-bold transition-all">å€‹äººç¨äº«</button>
                            </div>
                            <div v-if="newExpense.splitType === 'individual'" class="mt-2 animate-fade-in-down">
                                <label class="text-[10px] text-stone-400 ml-1">æ˜¯èª°çš„æ¶ˆè²»ï¼Ÿ</label>
                                <select v-model="newExpense.forWhom" class="w-full bg-stone-50 p-3 rounded-lg text-sm outline-none border border-stone-100"><option v-for="m in membersList" :value="m.name">{{ m.name }}</option></select>
                            </div>
                        </div>
                        <button @click="saveExpense" class="w-full bg-stone-800 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-stone-700 transition-colors">{{ editingExpenseId ? 'å„²å­˜è®Šæ›´' : 'è¨˜å¸³' }}</button>
                    </div>

                    <!-- Expense List -->
                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-2 px-1"><h3 class="font-bold text-stone-700">æœ€è¿‘æ¶ˆè²»</h3><span class="text-sm font-bold text-stone-500">ç¸½è¨ˆ: ç´„ NT${{ totalExpense.toLocaleString() }}</span></div>
                        <div class="space-y-3">
                            <div v-if="expenses.length === 0" class="text-center py-8 text-stone-400 text-sm">é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„</div>
                            <div v-for="(exp, idx) in expenses" :key="exp.id" class="bg-white p-4 rounded-xl flex justify-between items-center card-shadow border border-stone-50 relative group" :class="{'ring-2 ring-stone-200': editingExpenseId === exp.id}">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-500"><i :class="getCategoryIcon(exp.category)"></i></div>
                                    <div><p class="font-bold text-stone-700">{{ exp.item }}</p><p class="text-xs text-stone-400"><span class="bg-stone-100 px-1 rounded text-stone-500 mr-1">{{ exp.payer }}ä»˜</span><span v-if="exp.splitType === 'average'"> (å¹³åˆ†)</span><span v-else> (å¹«{{ exp.forWhom }}è²·)</span></p></div>
                                </div>
                                <div class="text-right"><p class="font-bold text-stone-800">{{ exp.currency === 'TWD' ? 'NT$' : 'Â¥' }}{{ exp.amount }}</p><p class="text-xs text-stone-400">{{ exp.date_str }}</p></div>
                                <div class="absolute -right-2 -top-2 flex gap-1">
                                    <button @click="openEditExpense(exp)" class="w-8 h-8 bg-stone-100 text-stone-500 rounded-full flex items-center justify-center shadow-sm border border-stone-200 active:scale-95 transition-transform"><i class="fa-solid fa-pen text-xs"></i></button>
                                    <button @click="deleteExpense(exp.id)" class="w-8 h-8 bg-red-50 text-red-400 rounded-full flex items-center justify-center shadow-sm border border-red-100 active:scale-95 transition-transform"><i class="fa-solid fa-times text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Tab -->
                <div v-if="activeTab === 'backup'">
                    <div class="bg-matcha/20 p-6 rounded-3xl mb-6 flex justify-between items-center">
                        <div><h2 class="text-2xl font-bold text-stone-700 mb-1">å‚™ç”¨æ–¹æ¡ˆ</h2><p class="text-stone-600 text-sm opacity-80">è¨˜éŒ„æƒ³å»ä½†æ™‚é–“ä¸ç¢ºå®šçš„åœ°æ–¹</p></div>
                        <button @click="showBackupModal = true" class="bg-stone-800 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div v-if="backupSpotsList.length === 0" class="text-center py-10 text-stone-400"><i class="fa-solid fa-bookmark text-4xl mb-3 opacity-30"></i><p>é‚„æ²’æœ‰å‚™ç”¨æ™¯é»</p></div>
                        <div v-for="spot in backupSpotsList" :key="spot.id" class="bg-white p-4 rounded-2xl card-shadow border border-stone-50 flex flex-col gap-2 relative group">
                            <div class="flex justify-between items-start"><h3 class="font-bold text-stone-700 text-lg">{{ spot.name }}</h3><button @click="deleteBackupSpot(spot.id)" class="text-stone-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                            <p class="text-sm text-stone-500">{{ spot.desc }}</p>
                            <button @click="openGoogleMap(spot.name)" class="mt-2 text-xs font-bold text-stone-400 self-start flex items-center bg-stone-100 px-3 py-1.5 rounded-full hover:bg-stone-200 transition-colors"><i class="fa-solid fa-location-dot mr-1"></i> å°èˆª</button>
                        </div>
                    </div>
                </div>

                <!-- AI Guide Tab -->
                <div v-if="activeTab === 'ai-guide'" class="flex flex-col h-full">
                    <div class="text-center mb-4 flex-shrink-0 mt-4"><div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-tr from-purple-100 to-blue-100 text-purple-600 mb-2 ring-4 ring-white shadow-sm"><i class="fa-solid fa-sparkles text-xl"></i></div><h2 class="text-lg font-bold text-stone-800">AI éš¨èº«å°éŠ</h2><p class="text-xs text-stone-500">ç›®å‰åœ¨: <span class="font-bold text-stone-700">{{ currentDayInfo.location }}</span></p></div>
                    <div id="chat-container" class="flex-1 overflow-y-auto px-2 space-y-4 no-scrollbar">
                        <div v-for="(msg, index) in chatMessages" :key="index" class="flex w-full message-anim" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                            <div v-if="msg.role === 'model'" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center mr-2 shrink-0 border border-stone-200"><i class="fa-solid fa-robot text-xs text-stone-500"></i></div>
                            <div class="max-w-[80%] rounded-2xl px-4 py-3 text-sm shadow-sm" :class="msg.role === 'user' ? 'bg-stone-800 text-white rounded-tr-none' : 'bg-white border border-stone-100 text-stone-700 rounded-tl-none'">
                                <div v-if="msg.role === 'model'" class="prose prose-sm" v-html="renderMarkdown(msg.text)"></div><div v-else>{{ msg.text }}</div>
                            </div>
                        </div>
                        <div v-if="isAiLoading" class="flex w-full justify-start"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center mr-2 shrink-0 border border-stone-200"><i class="fa-solid fa-robot text-xs text-stone-500"></i></div><div class="bg-white border border-stone-100 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm flex items-center gap-1"><div class="w-1.5 h-1.5 bg-stone-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-stone-400 rounded-full typing-dot" style="animation-delay: 0.2s"></div><div class="w-1.5 h-1.5 bg-stone-400 rounded-full typing-dot" style="animation-delay: 0.4s"></div></div></div>
                    </div>
                    <div class="mt-4 px-2 flex gap-2 overflow-x-auto no-scrollbar pb-2 flex-shrink-0">
                        <button @click="quickAsk('é€™é™„è¿‘æœ‰ä»€éº¼å¥½åƒçš„ï¼Ÿ')" class="flex items-center whitespace-nowrap px-3 py-1.5 bg-white border border-stone-200 rounded-full text-xs text-stone-600 shadow-sm active:scale-95 transition-transform"><span class="mr-1">ğŸœ</span> æ¨è–¦ç¾é£Ÿ</button>
                        <button @click="quickAsk('é€™è£¡æœ‰ä»€éº¼å¿…è²·ä¼´æ‰‹ç¦®ï¼Ÿ')" class="flex items-center whitespace-nowrap px-3 py-1.5 bg-white border border-stone-200 rounded-full text-xs text-stone-600 shadow-sm active:scale-95 transition-transform"><span class="mr-1">ğŸ</span> ä¼´æ‰‹ç¦®</button>
                        <button @click="quickAsk('å¹«æˆ‘çœ‹çœ‹ä»Šå¤©çš„è¡Œç¨‹é †ä¸é †')" class="flex items-center whitespace-nowrap px-3 py-1.5 bg-white border border-stone-200 rounded-full text-xs text-stone-600 shadow-sm active:scale-95 transition-transform"><span class="mr-1">ğŸ“</span> æª¢æŸ¥è¡Œç¨‹</button>
                    </div>
                    <div class="mt-2 p-2 bg-white rounded-2xl border border-stone-200 flex items-center shadow-sm relative flex-shrink-0">
                        <input v-model="userInput" @keyup.enter="sendAiMessage" type="text" placeholder="å•å• AI å°éŠ..." class="flex-1 bg-transparent outline-none text-sm px-2 text-stone-700" :disabled="isAiLoading">
                        <button @click="sendAiMessage" class="w-8 h-8 rounded-xl bg-stone-800 text-white flex items-center justify-center disabled:opacity-50 transition-colors" :disabled="!userInput || isAiLoading"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3. å°è¦½åˆ— (Nav) - è‡ªç„¶å †ç–Š -->
        <nav class="flex-none z-50 bg-white/90 backdrop-blur-md border-t border-stone-100 pb-safe-bottom">
            <div class="flex justify-between items-center h-16 px-6">
                <button @click="changeTab('itinerary')" :class="activeTab === 'itinerary' ? 'text-stone-800' : 'text-stone-300'" class="flex flex-col items-center transition-colors w-12"><i class="fa-solid fa-calendar-day text-xl mb-1"></i><span class="text-[10px] font-medium">è¡Œç¨‹</span></button>
                <button @click="changeTab('wallet')" :class="activeTab === 'wallet' ? 'text-stone-800' : 'text-stone-300'" class="flex flex-col items-center transition-colors w-12"><i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-medium">è¨˜å¸³</span></button>
                <button @click="changeTab('backup')" :class="activeTab === 'backup' ? 'text-stone-800' : 'text-stone-300'" class="flex flex-col items-center transition-colors w-12"><i class="fa-solid fa-bookmark text-xl mb-1"></i><span class="text-[10px] font-medium">å‚™æ¡ˆ</span></button>
                <button @click="changeTab('ai-guide')" :class="activeTab === 'ai-guide' ? 'text-purple-600' : 'text-stone-300'" class="flex flex-col items-center transition-colors w-12"><i class="fa-solid fa-sparkles text-xl mb-1" :class="activeTab === 'ai-guide' ? 'animate-pulse' : ''"></i><span class="text-[10px] font-medium">AI å°éŠ</span></button>
            </div>
        </nav>

        <!-- Modals (Overlay) -->
        <!-- Add/Edit Itinerary Modal -->
        <div v-if="showAddModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold text-stone-800 mb-4">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-stone-400">æ—¥æœŸ</label><input v-model="newEvent.date" type="date" class="w-full bg-stone-50 p-3 rounded-xl mt-1 outline-none"></div>
                    <div><label class="text-xs font-bold text-stone-400">æ™‚é–“</label><input v-model="newEvent.time" type="time" class="w-full bg-stone-50 p-3 rounded-xl mt-1 outline-none"></div>
                    <div><label class="text-xs font-bold text-stone-400">åœ°é» / æ´»å‹•</label><input v-model="newEvent.place" type="text" class="w-full bg-stone-50 p-3 rounded-xl mt-1 outline-none" placeholder="ä¾‹å¦‚ï¼šåƒæ‹‰éºµ"></div>
                    <div><label class="text-xs font-bold text-stone-400">å‚™è¨»</label><input v-model="newEvent.note" type="text" class="w-full bg-stone-50 p-3 rounded-xl mt-1 outline-none" placeholder="è¦æ’éšŠ..."></div>
                    <div class="flex gap-3 mt-6"><button @click="showAddModal = false" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold">å–æ¶ˆ</button><button @click="saveEvent" class="flex-1 py-3 rounded-xl bg-stone-800 text-white font-bold shadow-lg">{{ isEditing ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢' }}</button></div>
                </div>
            </div>
        </div>

        <!-- Add Backup Spot Modal -->
        <div v-if="showBackupModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold text-stone-800 mb-4">æ–°å¢å‚™ç”¨æ™¯é»</h3>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-stone-400">æ™¯é»åç¨±</label><input v-model="newBackup.name" type="text" class="w-full bg-stone-50 p-3 rounded-xl mt-1 outline-none" placeholder="ä¾‹å¦‚ï¼šè²“å’–å•¡"></div>
                    <div><label class="text-xs font-bold text-stone-400">èªªæ˜ / å‚™è¨»</label><input v-model="newBackup.desc" type="text" class="w-full bg-stone-50 p-3 rounded-xl mt-1 outline-none" placeholder="é›¨å¤©å»..."></div>
                    <div class="flex gap-3 mt-6"><button @click="showBackupModal = false" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold">å–æ¶ˆ</button><button @click="addBackupSpot" class="flex-1 py-3 rounded-xl bg-stone-800 text-white font-bold shadow-lg">æ–°å¢</button></div>
                </div>
            </div>
        </div>

        <!-- Member Management Modal -->
        <div v-if="showMemberModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold text-stone-800 mb-4">æˆå“¡ç®¡ç†</h3>
                <div class="space-y-3 mb-6 max-h-60 overflow-y-auto no-scrollbar">
                    <div v-if="membersList.length === 0" class="text-center text-sm text-stone-400">å°šç„¡æˆå“¡</div>
                    <div v-for="m in membersList" :key="m.id" class="flex justify-between items-center bg-stone-50 p-3 rounded-xl">
                        <div v-if="editingMemberId === m.id" class="flex flex-1 items-center gap-2">
                             <input ref="editMemberInput" v-model="editingMemberName" type="text" class="flex-1 bg-white border border-stone-200 p-2 rounded-lg text-sm outline-none" @keyup.enter="saveMemberName(m.id)">
                             <button @click="saveMemberName(m.id)" class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-check"></i></button>
                             <button @click="cancelEditMember" class="w-8 h-8 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div v-else class="flex justify-between items-center w-full">
                            <span class="font-bold text-stone-700">{{ m.name }}</span>
                            <div class="flex gap-2">
                                <button @click="startEditMember(m)" class="w-8 h-8 bg-white border border-stone-200 text-stone-400 rounded-full flex items-center justify-center hover:text-stone-600 hover:border-stone-400"><i class="fa-solid fa-pen text-xs"></i></button>
                                <button v-if="membersList.length > 1" @click="deleteMember(m.id)" class="w-8 h-8 bg-red-50 text-red-400 rounded-full flex items-center justify-center hover:bg-red-100"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 mb-2">
                    <input v-model="newMemberName" type="text" class="flex-1 bg-stone-50 p-3 rounded-xl outline-none border border-stone-100 focus:border-stone-300" placeholder="è¼¸å…¥æ–°æˆå“¡åå­— (ä¾‹å¦‚: å°æ˜)">
                    <button @click="addMember" class="bg-stone-800 text-white px-4 rounded-xl font-bold shadow-md"><i class="fa-solid fa-plus"></i></button>
                </div>
                <button @click="showMemberModal = false" class="w-full py-3 mt-4 rounded-xl bg-stone-100 text-stone-500 font-bold">å®Œæˆ</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB-ScmQ2CR_mELTyeu-656hvWGxkOxJG2s",
            authDomain: "sanyo-2fd4a.firebaseapp.com",
            projectId: "sanyo-2fd4a",
            storageBucket: "sanyo-2fd4a.firebasestorage.app",
            messagingSenderId: "1034436486956",
            appId: "1:1034436486956:web:937c503c89b7a095ed2e89"
        };

        try {
            console.log("Firebase starting...");
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            window.firebaseApp = {
                db, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, isReady: true
            };
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("Firebase é€£ç·šå¤±æ•—: " + e.message);
        }
    </script>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        const apiKey = ""; 

        const app = createApp({
            setup() {
                const dbConnected = ref(false);
                const activeTab = ref('itinerary');
                const showAddModal = ref(false);
                const showBackupModal = ref(false);
                const showMemberModal = ref(false);
                const selectedDate = ref('2025-12-16');
                const calcAmount = ref('');
                const exchangeRate = ref(0.215);
                const dateScroller = ref(null);
                
                const eventsList = ref([]);
                const expensesList = ref([]);
                const backupSpotsList = ref([]);
                const membersList = ref([]);
                
                const chatMessages = ref([{ role: 'model', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æ—…éŠåŠ©æ‰‹ã€‚æœ‰é—œè¡Œç¨‹ã€äº¤é€šæˆ–ç¾é£Ÿçš„å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼âœ¨' }]);
                const userInput = ref('');
                const isAiLoading = ref(false);

                const isEditing = ref(false);
                const editingId = ref(null);
                const editingMemberId = ref(null);
                const editingMemberName = ref('');
                const editingExpenseId = ref(null);

                const connectionStatusText = computed(() => dbConnected.value ? 'å·²åŒæ­¥' : (!window.firebaseApp ? 'é€£ç·šä¸­...' : 'é›¢ç·šæ¨¡å¼'));
                const connectionStatusClass = computed(() => dbConnected.value ? 'status-online' : (!window.firebaseApp ? 'status-connecting' : 'status-offline'));

                const tripDays = [
                    { date: '2025-12-16', dayNum: '16', dayOfWeek: 'é€±äºŒ', location: 'å¤§é˜ª', hotel: 'KIX å‘¨é‚Š', coords: [34.4347, 135.2447] },
                    { date: '2025-12-17', dayNum: '17', dayOfWeek: 'é€±ä¸‰', location: 'å»£å³¶', hotel: 'å»£å³¶å¸‚å€', coords: [34.3853, 132.4553] },
                    { date: '2025-12-18', dayNum: '18', dayOfWeek: 'é€±å››', location: 'å®®å³¶', hotel: 'å»£å³¶å¸‚å€', coords: [34.2978, 132.3195] },
                    { date: '2025-12-19', dayNum: '19', dayOfWeek: 'é€±äº”', location: 'å€‰æ•·', hotel: 'å€‰æ•·å¸‚', coords: [34.5960, 133.7716] },
                    { date: '2025-12-20', dayNum: '20', dayOfWeek: 'é€±å…­', location: 'ç¥æˆ¶', hotel: 'ç¥æˆ¶å¸‚', coords: [34.6901, 135.1955] },
                    { date: '2025-12-21', dayNum: '21', dayOfWeek: 'é€±æ—¥', location: 'ç¥æˆ¶', hotel: 'Home', coords: [34.6328, 135.2239] },
                ];

                const newEvent = ref({ date: '', time: '', place: '', note: '' });
                const newExpense = ref({ item: '', amount: '', category: 'food', payer: '', splitType: 'average', forWhom: '', currency: 'JPY' });
                const newBackup = ref({ name: '', desc: '' });
                const newMemberName = ref('');

                const currentDayInfo = computed(() => tripDays.find(d => d.date === selectedDate.value) || tripDays[0]);
                
                const getEventsForDay = (date) => {
                    return eventsList.value.filter(e => e.date === date).sort((a,b) => a.time.localeCompare(b.time));
                };
                
                const currentDayEvents = computed(() => getEventsForDay(selectedDate.value));
                const expenses = computed(() => expensesList.value.sort((a, b) => b.createdAt - a.createdAt));
                
                const totalExpense = computed(() => expensesList.value.reduce((sum, item) => {
                    const amount = parseInt(item.amount) || 0;
                    const val = item.currency === 'TWD' ? amount : Math.round(amount * exchangeRate.value);
                    return sum + val;
                }, 0));

                const convertedTWD = computed(() => !calcAmount.value ? 0 : Math.round(calcAmount.value * exchangeRate.value));

                // Settlement
                const settlementData = computed(() => {
                    const data = {};
                    membersList.value.forEach(m => { data[m.name] = { name: m.name, paid: 0, shouldPay: 0, balance: 0 }; });
                    expensesList.value.forEach(exp => {
                        const amount = parseInt(exp.amount) || 0;
                        const valueInTwd = exp.currency === 'TWD' ? amount : Math.round(amount * exchangeRate.value);
                        const payer = exp.payer;
                        if (data[payer]) data[payer].paid += valueInTwd;
                        if (exp.splitType === 'individual' && exp.forWhom) {
                            if (data[exp.forWhom]) data[exp.forWhom].shouldPay += valueInTwd;
                        } else {
                            const count = membersList.value.length;
                            if (count > 0) {
                                const share = Math.round(valueInTwd / count);
                                membersList.value.forEach(m => { if(data[m.name]) data[m.name].shouldPay += share; });
                            }
                        }
                    });
                    return Object.values(data).map(p => { p.balance = Math.round(p.paid - p.shouldPay); return p; });
                });

                // Init
                const initDB = () => {
                    if (window.firebaseApp && window.firebaseApp.isReady) {
                        const { db, collection, onSnapshot, query, addDoc } = window.firebaseApp;
                        const checkConn = () => { if(!dbConnected.value) dbConnected.value = true; };
                        try {
                            onSnapshot(query(collection(db, "trip_events")), (snapshot) => {
                                eventsList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                checkConn();
                            });
                            onSnapshot(query(collection(db, "trip_expenses")), (snap) => {
                                expensesList.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                checkConn();
                            });
                            onSnapshot(query(collection(db, "trip_backups")), (snap) => {
                                backupSpotsList.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                checkConn();
                            });
                            onSnapshot(query(collection(db, "trip_members")), (snap) => {
                                const members = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                checkConn();
                                if (members.length === 0) {
                                    addDoc(collection(db, "trip_members"), { name: 'æˆ‘' });
                                    addDoc(collection(db, "trip_members"), { name: 'æ—…ä¼´' });
                                } else {
                                    membersList.value = members;
                                    if(!newExpense.value.payer && members.length > 0) newExpense.value.payer = members[0].name;
                                    if(!newExpense.value.forWhom && members.length > 0) newExpense.value.forWhom = members[0].name;
                                }
                            });
                        } catch (e) { console.error(e); }
                    }
                };

                onMounted(() => {
                    if (window.firebaseApp && window.firebaseApp.isReady) initDB();
                    else window.addEventListener('firebase-ready', initDB);
                });

                // Actions
                const safeAction = async (actionFn) => {
                    if (!dbConnected.value) { alert("å°šæœªé€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¦å‰‡ã€‚"); return; }
                    try { await actionFn(); } catch (e) { console.error(e); alert("æ“ä½œå¤±æ•—: " + e.message); }
                };

                const addMember = () => safeAction(async () => {
                    if (!newMemberName.value) return;
                    await window.firebaseApp.addDoc(window.firebaseApp.collection(window.firebaseApp.db, "trip_members"), { name: newMemberName.value });
                    newMemberName.value = '';
                });
                const deleteMember = (id) => safeAction(async () => {
                    if (membersList.value.length <= 1) { alert("è‡³å°‘è¦æœ‰ä¸€å€‹æˆå“¡"); return; }
                    await window.firebaseApp.deleteDoc(window.firebaseApp.doc(window.firebaseApp.db, "trip_members", id));
                });
                const startEditMember = (member) => { editingMemberId.value = member.id; editingMemberName.value = member.name; };
                const cancelEditMember = () => { editingMemberId.value = null; editingMemberName.value = ''; };
                const saveMemberName = (id) => safeAction(async () => {
                    if (!editingMemberName.value.trim()) return;
                    await window.firebaseApp.updateDoc(window.firebaseApp.doc(window.firebaseApp.db, "trip_members", id), { name: editingMemberName.value });
                    cancelEditMember();
                });

                const openAddModal = () => { isEditing.value = false; editingId.value = null; newEvent.value = { date: selectedDate.value, time: '', place: '', note: '' }; showAddModal.value = true; };
                const openEditModal = (item) => { isEditing.value = true; editingId.value = item.id; newEvent.value = { date: item.date, time: item.time, place: item.place, note: item.note }; showAddModal.value = true; };
                const saveEvent = () => safeAction(async () => {
                    if (!newEvent.value.place || !newEvent.value.date) return;
                    const { db, collection, addDoc, doc, updateDoc } = window.firebaseApp;
                    if (isEditing.value && editingId.value) {
                        await updateDoc(doc(db, "trip_events", editingId.value), newEvent.value);
                    } else {
                        await addDoc(collection(db, "trip_events"), { ...newEvent.value, type: 'Added', createdAt: Date.now() });
                    }
                    showAddModal.value = false;
                });
                const deleteEvent = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) safeAction(async () => await window.firebaseApp.deleteDoc(window.firebaseApp.doc(window.firebaseApp.db, "trip_events", id))); };

                const addBackupSpot = () => safeAction(async () => {
                    if (!newBackup.value.name) return;
                    await window.firebaseApp.addDoc(window.firebaseApp.collection(window.firebaseApp.db, "trip_backups"), { name: newBackup.value.name, desc: newBackup.value.desc || '', createdAt: Date.now() });
                    newBackup.value = { name: '', desc: '' }; showBackupModal.value = false;
                });
                const deleteBackupSpot = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) safeAction(async () => await window.firebaseApp.deleteDoc(window.firebaseApp.doc(window.firebaseApp.db, "trip_backups", id))); };

                const saveExpense = () => safeAction(async () => {
                    if (!newExpense.value.item || !newExpense.value.amount || !newExpense.value.payer) return;
                    const { db, collection, addDoc, doc, updateDoc } = window.firebaseApp;
                    const expenseData = {
                        item: newExpense.value.item,
                        amount: parseInt(newExpense.value.amount),
                        currency: newExpense.value.currency || 'JPY',
                        category: newExpense.value.category,
                        payer: newExpense.value.payer,
                        splitType: newExpense.value.splitType,
                        forWhom: newExpense.value.splitType === 'individual' ? newExpense.value.forWhom : '',
                        date_str: new Date().toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}),
                    };
                    if (editingExpenseId.value) {
                        await updateDoc(doc(db, "trip_expenses", editingExpenseId.value), expenseData);
                    } else {
                        await addDoc(collection(db, "trip_expenses"), { ...expenseData, createdAt: Date.now() });
                    }
                    newExpense.value = { item: '', amount: '', category: 'food', payer: membersList.value[0]?.name || '', splitType: 'average', forWhom: membersList.value[0]?.name || '', currency: 'JPY' };
                    editingExpenseId.value = null;
                });
                const deleteExpense = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) safeAction(async () => await window.firebaseApp.deleteDoc(window.firebaseApp.doc(window.firebaseApp.db, "trip_expenses", id))); };
                const openEditExpense = (item) => {
                    editingExpenseId.value = item.id;
                    newExpense.value = { item: item.item, amount: item.amount, currency: item.currency || 'JPY', category: item.category, payer: item.payer, splitType: item.splitType || 'average', forWhom: item.forWhom || (membersList.value[0]?.name || '') };
                };
                const cancelEditExpense = () => { editingExpenseId.value = null; newExpense.value = { item: '', amount: '', category: 'food', payer: membersList.value[0]?.name || '', splitType: 'average', forWhom: membersList.value[0]?.name || '', currency: 'JPY' }; }

                const jumpToDate = (date) => { selectedDate.value = date; const el = document.getElementById('view-' + date); if (el) el.scrollIntoView({ behavior: 'smooth', inline: 'center' }); };
                const handleDayScroll = (e) => {
                    const container = e.target;
                    const index = Math.round(container.scrollLeft / container.clientWidth);
                    if (tripDays[index] && tripDays[index].date !== selectedDate.value) selectedDate.value = tripDays[index].date;
                };
                const selectDate = (date) => jumpToDate(date);
                watch(selectedDate, (newVal) => { 
                    nextTick(() => {
                        if (activeTab.value === 'itinerary' && dateScroller.value) {
                            const btn = document.getElementById('date-btn-' + newVal);
                            if (btn) dateScroller.value.scrollTo({ left: btn.offsetLeft - (dateScroller.value.clientWidth / 2) + (btn.clientWidth / 2), behavior: 'smooth' });
                        }
                    });
                });
                const changeTab = (tab) => { activeTab.value = tab; if (tab === 'ai-guide') nextTick(() => document.getElementById('chat-container')?.scrollTo(0, 9999)); };
                const editRate = () => { const r = prompt('è¼¸å…¥åŒ¯ç‡', exchangeRate.value); if (r) exchangeRate.value = parseFloat(r); };
                const openGoogleMap = (query) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
                const getCategoryIcon = (cat) => { const i = { food: 'fa-utensils', transport: 'fa-train-subway', shopping: 'fa-bag-shopping', stay: 'fa-bed', ticket: 'fa-ticket' }; return `fa-solid ${i[cat] || 'fa-circle'}`; };
                const getWeatherIcon = (code) => { return 'fa-solid fa-sun text-yamabuki'; };
                const quickAsk = (question) => { userInput.value = question; sendAiMessage(); }
                const sendAiMessage = async () => {
                    if (!userInput.value.trim()) return;
                    if (!apiKey) { alert("è«‹å¡«å…¥ API Key"); return; }
                    const text = userInput.value; chatMessages.value.push({ role: 'user', text }); userInput.value = ''; isAiLoading.value = true;
                    const systemContext = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ã€è¦ªåˆ‡çš„æ—¥æœ¬æ—…éŠåŠ©æ‰‹ã€‚`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: systemContext }] }] }) });
                        const data = await response.json();
                        chatMessages.value.push({ role: 'model', text: data.candidates?.[0]?.content?.parts?.[0]?.text || "Error" });
                    } catch (e) { chatMessages.value.push({ role: 'model', text: "Error: " + e.message }); } finally { isAiLoading.value = false; nextTick(() => document.getElementById('chat-container')?.scrollTo(0, 9999)); }
                };
                const renderMarkdown = (text) => marked.parse(text);
                const locateMe = () => { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { alert(`ä½ çš„ä½ç½®: ${pos.coords.latitude}, ${pos.coords.longitude}`); }); } else { alert("ç„¡æ³•å–å¾—ä½ç½®"); } };

                return { 
                    dbConnected, activeTab, tripDays, selectedDate, currentDayInfo, currentDayEvents, selectDate, jumpToDate, handleDayScroll, changeTab, deleteEvent, showAddModal, showBackupModal, showMemberModal, newEvent, newBackup, newMemberName, membersList, openAddModal, openEditModal, saveEvent, addBackupSpot, deleteBackupSpot, addMember, deleteMember, startEditMember, cancelEditMember, saveMemberName, openGoogleMap, expenses, newExpense, saveExpense, deleteExpense, openEditExpense, cancelEditExpense, totalExpense, getCategoryIcon, calcAmount, convertedTWD, exchangeRate, editRate, backupSpotsList, getWeatherIcon, locateMe, chatMessages, userInput, isAiLoading, sendAiMessage, quickAsk, renderMarkdown, connectionStatusText, connectionStatusClass, isEditing, editingMemberId, editingMemberName, settlementData, editingExpenseId, getEventsForDay, dateScroller
                };
            }
        });
        app.mount('#app');
    </script>
</body>
</html>